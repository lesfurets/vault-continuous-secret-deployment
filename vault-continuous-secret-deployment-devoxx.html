<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Deploying your application secrets: Hashicorp Vault and continuous delivery</title>
    <meta name="description" content="Managing application secrets, like database credentials, passphrases, salts and private keys, is hard. The availability of those elements are critical to the application, yet they need to be properly secured to reduce the attack surface on your system. Most secret management systems, like Hashicorp Vault, are used as a centralized database, but it creates a single point of failure and it requires extra care in hardening the security of that system. How about deploying your secrets, in Hashicorp Vault, alongside your application? By leveraging your build infrastructure, you can deploy a copy of your secrets in a Vault that is secured using a one-time token, accessible only by your application. In this presentation, we'll show a continuous delivery pipeline that enables that approach, talk about the implications of handling secrets in your build infrastructure, and use threat modeling to verify the security of the deployed Vault.">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="bower_components/reveal.js/css/reveal.css">
    <link rel="stylesheet" href="bower_components/reveal.js/lib/css/zenburn.css">
    <link rel="stylesheet" href="css/theme.css" id="theme">
    <script>
      if (window.location.search.match(/print-pdf/gi)) {
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = 'css/print/pdf.css';
        document.getElementsByTagName('head')[0].appendChild(link);
      }
    </script>
  </head>

  <body>
    <div class="footer">
      <img class="logo-lesfurets" src="img/logo_lesfurets_blanc.png">
      <a href="https://twitter.com/dubreuia">twitter: @dubreuia</a>
      <a href="https://github.com/dubreuia">github: @dubreuia</a>
      <img class="logo-conference" src="img/logo_devoxx_france.jpg">
    </div>
    <div class="reveal">
      <div class="slides">

        <section>
          <img class="logo herve-francois" width="45%" src="img/lf_com_herve_francois.png">
          <h1>Deploying your application secrets: Hashicorp Vault and continuous delivery</h1>
          <h2>Alexandre DuBreuil</h2>
        </section>

        <section>
          <section>
            <h2>Welcome to the Furets!</h2>
          </section>
          <section>
            <div class="">
              <h2>@dubreuia â€“ Alexandre DuBreuil</h2>
              <ul>
                <li>TODO</li>
              </ul>
            </div>
          </section>
          <section>
            <img width="50%" src="img/logo_lesfurets.png">
            <p></p>
            <ul class="">
              <li>1 website, 5 Insurance Products : Car, Health, Home, Bike, Loan</li>
              <li class="emptyline">1 codebase, 450k lines of code, 60k unit tests, 150 selenium tests</li>
              <li>22 Developers, 2 DevOps, 4 Architects</li>
              <li class="emptyline">19 production servers including Load balancers, Frontend, Backend, Databases, BI</li>
              <li>1 release per day</li>
              <li class="emptyline">9 years of code history
                <br/>
              </li>
              <li>3M quotes/year, 40% of market share, 4M of customers</li>
            </ul>
          </section>
        </section>

        <section>
          <section>
            <h2>Context</h2>
          </section>

          <section data-transition="slide-in fade-out">
            <img width="66%" src="img/lf_car_journey.png">
          </section>

          <section data-transition="fade-in slide-out">
            <img width="66%" src="img/lf_com_car_price_sheet.png">
          </section>

          <section>
            <h2>Web application secrets</h2>
            <p>We define a <strong>secret</strong> as information that can be used to access sensitive data. Pretty much any information that we cannot put on a public repository. That includes:</p>
            <ul>
              <li>Insurer web service credentials (username, password)</li>
              <li>Encryption keys and key passphrases</li>
              <li>Salt for passwords and passphrases</li>
              <li>Database credentials (username, password)</li>
              <li><strong>Out of scope:</strong> customer credentials, PII</li>
            </ul>
          </section>

          <section>
            <h2>Secret in Java file</h2>
            <div class="code-wrapper">
              <pre class="prettyprint">
                <code class="code lang-java">
public class ClientPasswordCallback implements CallbackHandler {

  private static final String username = <mark class="fragment">"lesfurets"</mark>;
  private static final String password = <mark class="fragment">"hunter2"</mark>;

  @Override
  public void handle(Callback[] callbacks) {
    final WSPasswordCallback pc = (WSPasswordCallback) callbacks[0];
    if (username.equals(pc.getIdentifier())) {
      pc.setPassword(password);
    }
  }

}
                </code>
              </pre>
            </div>
          </section>

          <section>
            <h2>Secret in Tomcat server.xml</h2>
            <div class="code-wrapper">
              <pre class="prettyprint">
                <code class="code lang-xml">
&lt;?xml version='1.0' encoding='utf-8'?&gt;
&lt;Server port="1234" shutdown="SHUTDOWN"&gt;
  &lt;!-- ... --&gt;
  &lt;GlobalNamingResources&gt;
    &lt;Resource name="jdbc/b2b2cDatabase" 
              username="<mark class="fragment">dev</mark>"
              password="<mark class="fragment">hunter2</mark>"
              url="localhost:2345"
              type="javax.sql.DataSource"
              driverClassName="org.mariadb.jdbc.Driver"
              jdbcInterceptors="..."/&gt;
  &lt;/GlobalNamingResources&gt;
  &lt;!-- ... --&gt;
&lt;/Server&gt;
                </code>
              </pre>
            </div>
          </section>

          <section>
            <h2>Today's objective</h2>
            <p>Remove secrets from code and production machines</p>
          </section>

          <section>
            <h2>Prerequisite: Infrastructure as code</h2>
            <p>If you do <strong>infratructure as code</strong>, you probably have secrets in your source code. We want to keep infra as code, but remove the secrets.</p>
            <!-- https://image.slidesharecdn.com/deepdive-infrastructureascode-150702131406-lva1-app6892/95/deep-dive-infrastructure-as-code-17-638.jpg?cb=1435843061 -->
            <img width="33%" src="img/infra_as_code.jpg">
          </section>

          <section>
            <h2>Prerequisite: Lambda infrastructure</h2>
            <p><strong>Lambda architecture</strong> batch data layer means you can reconstruct the past "easily"</p>
            <p><strong>Lambda infrastructure</strong> infra as code means you can reconstruct a machine "easily"</p>
            <p><strong>Lambda security</strong> means you can trash your secrets and reconstruct them "easily"</p>
          </section>

          <section>
            <h2>Prerequisite: Continuous delivery</h2>
            <p>At LesFurets we deliver code to production at least daily. Continuous delivery means that it is <strong>easy to push a feature to production</strong>, and also easy to push an <strong>old version in case of emergency</strong>.</p>
            <img width="10%" src="img/logo_jenkins.jpg">
            <img width="10%" src="img/logo_teamcity.jpg">
          </section>

          <section>
            <h2>Prerequisite: Infrastructure automation</h2>
            <p>Our machine provisioning and deployment is done with Ansible. It makes <strong>staging possible</strong> by facilitating the creation of new environment and enables <strong>lambda infrastructure</strong>.</p>
            <p>TODO overview of ansible</p>
            <img width="10%" src="img/logo_ansible.jpg">
            <img width="10%" src="img/logo_chef.jpg">
            <img width="10%" src="img/logo_puppet.jpg">
          </section>

          <section>
            <h2>Overview of password workflow</h2>
            <p>TODO move this section</p>
            <p>From code to production, different person with different access rights are handling secrets.</p>
            <ul>
              <li><strong class="color-zen-blue">Developer</strong> use password key in code (ex: <code>insurer_password</code>)</li>
              <li><strong class="color-zen-blue">Developer</strong> puts development value in code (ex: <code>hunter2</code>)</li>
              <li><strong class="color-zen-orange">Security</strong> admin adds production secret value in system</li>
              <li><strong class="color-zen-green">Developer</strong> deploys app without seeing the production value</li>
            </ul>
          </section>

        </section>

        <section>

          <section>
            <h2>Security</h2>
          </section>

          <section>
            <h2>Choosing a tool</h2>
            <p>Many tools are available for secrets management, yet not all will fit your purpose. Making your own <strong>custom solution</strong> might not be a good idea given how hard it is.</p>
            <p><strong>Ansible, Chef, etc.</strong> do not remove secrets on production machine (secrets retrieval at build time, not runtime)</p>
            <p><strong>Keywhiz</strong> very similar to Vault and could have been a good choice</p>
            <p><strong>Amazon KMS</strong> similar to Vault, less featured, and tied to the Amazon ecosystem</p>
            <p><strong>Azure Key Vault</strong> similar to Vault, tied to the Microsoft ecosystem</p>
          </section>

          <section>
            <h2>Hashicorp Vault</h2>
            <p>Lightweight, performant, open-source and battle hardened.</p>
            <ul>
              <li><strong>Seal</strong> and <strong>unseal</strong> makes your Vault safe (multiple key unlock)</li>
              <li><strong>Wrap</strong> secrets to distribute them safely</li>
              <li><strong>Authenticate</strong> with different methods (we're using token auth)</li>
              <li><strong>Single one-time connexion</strong> possible with wraped token</li>
              <li><strong>Audit log</strong> out of the box and easy to use</li>
            </ul>
            <p><img width="20%" src="img/logo_vault.jpg"></p>
          </section>

          <section>
            <h2>Our Vault usage context</h2>
            <p>Typical use case of Vault is somewhat different then what we'll see today: it is often used as a central database serving multiple apps and environments.</p>
            <img width="25%" src="img/vault_centralized.jpg">
            <img width="25%" src="img/vault_decentralized.jpg">
          </section>

          <section>
            <h2>Why use Vault decentralized?</h2>
            <ul>
              <li><strong>Continuous delivery</strong> easier to replace the secrets container</li>
              <li><strong>Attack surface</strong> infrastructure wide system with all the info</li>
              <li><strong>Staging</strong> deploying specific secrets for a specific env</li>
              <li><strong>SLA</strong> single point of failure, network issues</li>
              <li><strong>Master / slave</strong> configuration on enterprise solutions</li>
              <li><strong>Performance</strong> one local Vault per JVM is super-fast</li>
            </ul>
          </section>

<!--          <section> -->
<!--            <h2>Basic concepts</h2> -->
<!--            <p>Some concepts are required for this presentation</p> -->
<!--            <ul> -->
<!--              <li><strong>Secure Coding:</strong> TODO</li> -->
<!--              <li><strong>Threat model:</strong> a process by which potential (security) threats can be identified</li> -->
<!--              <li><strong>Attack surface:</strong> of a software environment is the sum of the different points where an unauthorized user can try to enter data to or extract data from an environment</li> -->
<!--              <li><strong>Man in the middle:</strong> is an attack where the attacker secretly relays and possibly alters the communication between two parties who believe they are directly communicating with each other</li> -->
<!--              <li><strong>One time password (OTP):</strong> is a password that is valid for only one login session or transaction</li> -->
<!--            </ul> -->
<!--          </section> -->

        </section>

        <section>

          <section>
            <h2>Threat model</h2>
          </section>

          <section>
            <h2>Threat model: STRIDE</h2>
            <p>There are many ways to do a threat model, one of them is using the STRIDE method.</p>
            <ul>
              <li><strong>S</strong>poofing of user identity</li>
              <li><strong>T</strong>ampering</li>
              <li><strong>R</strong>epudiation</li>
              <li><strong>I</strong>nformation disclosure</li>
              <li><strong>D</strong>enial of service</li>
              <li><strong>E</strong>levation of privilege</li>
            </ul>
          </section>

          <section>
            <img width="100%" src="img/vault_threat_model.jpg">
          </section>

          <section>
            <h2>Security design implications</h2>
            <p>TODO use the term "wraped token" and "connexion token"</p>
            <p>There is only <strong>one single use authentication token</strong>. Once it is used, there is no other way of connecting to the Vault.</p>
            <p>If the connexion to the Vault is lost, it is lost forever, the application needs to be redeployed.</p>
            <p>You can also make the application refresh the connexion each x seconds or the Vault token lease expires, which means the application would need to be redeployed.</p>
          </section>

        </section>

        <section>

          <section>
            <h2>In practice</h2>
          </section>

          <section>
            <h2>Overview of delivery pipeline</h2>
          </section>

          <section data-transition="slide-in fade-out">
            <img width="90%" src="img/vault_infra_01.jpg">
          </section>

          <section data-transition="fade-in slide-out">
            <img width="90%" src="img/vault_infra_02.jpg">
          </section>

          <section>
            <h2>Jenkins pipeline</h2>
            <div class="code-wrapper">
              <pre class="prettyprint">
                <code class="code lang-groovy">
dir('scripts/ansible') {
    withCredentials([usernamePassword(credentialsId: '<mark class="fragment">teamPasswordJenkinsUser</mark>',
                                      usernameVariable: 'teamPasswordJenkinsUsername',
                                      passwordVariable: 'teamPasswordJenkinsPassword')]) {
        withEnv(["TEAM_PASSWORD_USERNAME=${teamPasswordJenkinsUsername}",
                 "TEAM_PASSWORD_PASSWORD=${teamPasswordJenkinsPassword}"]) {
            sh """
            docker pull docker-hub.admin.courtanet.net/ansible
            docker run -w /playbooks \
                       -e TEAM_PASSWORD_USERNAME \
                       -e TEAM_PASSWORD_PASSWORD \
                       -v \$(pwd):/playbooks \
                       docker-hub.admin.courtanet.net/ansible ansible-playbook ./tomcat-b2c.yml \
                       --inventory=./hosts \
                       --extra-vars='version=${scmHash} target=${conf.nginxEnvName}'
            """
        }
    }
}
                </code>
              </pre>
            </div>
          </section>

          <section>
            <h2>Deploying vault with ansible</h2>
            <p>TODO</p>
            <div class="code-wrapper">
              <pre class="prettyprint">
                <code class="code lang-groovy">
[09:31:13] vault - localhost - <mark class="fragment">download from nexus</mark> ... | localhost | SUCCESS | 52ms
[09:31:14] vault - localhost - <mark class="fragment">unarchive artifact</mark> ... | localhost | CHANGED | 916ms
[09:31:15] vault - localhost - <mark class="fragment">fetch secrets</mark> ... | localhost | SUCCESS | 59ms
[09:32:23] vault - localhost - <mark class="fragment">create vault</mark> ... | localhost | CHANGED | 5225ms
[09:32:28] vault - localhost - <mark class="fragment">create sealed vault archive</mark> ... | localhost | CHANGED | 553ms
[09:32:28] vault - localhost - <mark class="fragment">set vault_key, vault_token</mark> ... | localhost | SUCCESS | 120ms
...
                </code>
              </pre>
            </div>
          </section>

          <section>
            <h2>Build infrastructure implications</h2>
            <p><strong>Fetch secrets</strong> should not write to disk to avoid leakage. Ansible is executed in a docker container, the secrets are put directly in vault.</p>
            <p><strong>The unseal key and auth token</strong> are not written to disk, they are kept in an Ansible variable, used, then discarded.</p>
            <p>There is only <strong>one single use authentication token</strong>. Once it is used, there is no other way of connecting to the Vault.</p>
            <p><strong>The sealed Vault</strong> can be distributed easily because it is unusable without the key (or the token)</p>
          </section>

          <section>
            <h2>Code demo: Bash code to create Vault</h2>
            <p>TODO</p>
          </section>

          <section>
            <h2>Code demo: Java code to query Vault</h2>
            <ul>
              <li>simple rest api</li>
              <li>library used: vault-java-driver</li>
              <li>secure coding: usage in production code</li>
            </ul>
          </section>

          <section>
            <div class="code-wrapper smaller">
              <pre class="prettyprint">
                <code class="code lang-groovy">
class ClientFactory {

    private static final String RESPONSE_WRAPPING_RESPONSE_PATH_KEY = "creation_path";
    private static final String RESPONSE_WRAPPING_TOKEN_VALID_PATH = "auth/token/create";

    static Vault initSecureClient() {
        try {
            LOG.info("Vault using certificate");
            SslConfig sslConfig = new SslConfig().pemFile(CERTIFICATE_PATH.toFile()).build();

            LOG.info("Vault response wrapping token validation");
            Vault vault = new Vault(new VaultConfig().sslConfig(sslConfig).address(ADDRESS).token(TOKEN).build());
            LogicalResponse lookup = vault.auth().lookupWrap();
            String creationPath = lookup.getData().get(RESPONSE_WRAPPING_RESPONSE_PATH_KEY);
            if (!RESPONSE_WRAPPING_TOKEN_VALID_PATH.equals(creationPath)) {
                throw logAndThrow("vault wrong wrapping token path '" + creationPath + "' token might be forged");
            }

            LOG.info("Vault unwrapping login token");
            String token = vault.auth().unwrap().getAuthClientToken();

            LOG.info("Vault starting secure connexion");
            return new Vault(new VaultConfig().sslConfig(sslConfig).address(ADDRESS).token(token).build());
        } catch (com.bettercloud.vault.VaultException e) {
            throw logAndThrow("secure init failed", e);
        }
    }

}
                </code>
              </pre>
            </div>
          </section>

          <section>
            <h2>Java design implications</h2>
            <p>The only connexion token is kept in memory: use a byte array to prevent direct memory dump exploitation</p>
            <p>Secure coding: TODO</p>
          </section>

        </section>

        <section>

          <section>
            <h2>Performance / scalability / monitoring / audit</h2>
          </section>

          <section>
            <h2>Decentralized nature makes it easier to manage</h2>
            <ul>
              <li>ex: batch fiches with salt</li>
              <li>statistics from our usage</li>
              <li>avoid network failures (local socket)</li>
            </ul>
          </section>

          <section>
            <h2>Monitoring</h2>
            <ul>
              <li>Datadog: cpu, mem, process number</li>
              <li>Logmatic: specific alert from vault service</li>
            </ul>
          </section>

          <section>
            <h2>Audit log</h2>
            <ul>
              <li>TODO</li>
            </ul>
          </section>

        </section>

        <section>

          <section>
            <h2>Pitfalls</h2>
          </section>

          <section>
            <h2>Security is hard</h2>
            <ul>
              <li>secrets migration: from cleartext to ciphertext, how to test?</li>
              <li>testing: software factory access to production creds?</li>
              <li>mocking</li>
              <li>build everything, everytime: certificate expiration</li>
              <li>database password in clear in logs</li>
            </ul>
          </section>

        </section>

        <section>

          <section>
            <h2>Conclusion</h2>
          </section>

          <section>
            <h2>TODO</h2>
          </section>

        </section>

        <section>

          <section>
            <h2>TODO</h2>
            <ul>
              <li>- what we're not using with vault</li>
              <li>- event log</li>
              <li>- https://www.vaultproject.io/docs/vs/chef-puppet-etc.html</li>
              <li>- https://www.hashicorp.com/blog/using-hashicorps-vault-with-chef</li>
              <li>- https://www.reddit.com/r/devops/comments/4hgxbh/hashicorps_vault_how_are_you_using_it/</li>
              <li>- https://www.reddit.com/r/devops/comments/8zmibk/aws_secrets_manager_vs_hashicorp_vault_what_can/</li>
            </ul>
          </section>

        </section>

      </div>
    </div>
    <script src="bower_components/reveal.js/lib/js/head.min.js"></script>
    <script src="bower_components/reveal.js/js/reveal.js"></script>
    <script>
      // Full list of configuration options available here:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: false,
        progress: true,
        history: true,
        center: true,
        embedded: true,
        mouseWheel: true,
        viewDistance: 5,

        width: 1280,
        height: 900,
        margin: 0,

        transition: Reveal.getQueryHash().transition || 'linear', // default/cube/page/concave/zoom/linear/fade/none

        // Optional libraries used to extend on reveal.js
        dependencies: [
          { src: 'bower_components/reveal.js/lib/js/classList.js', condition: function () { return !document.body.classList; } },
          { src: 'bower_components/reveal.js/plugin/markdown/marked.js', condition: function () { return !!document.querySelector('[data-markdown]'); } },
          { src: 'bower_components/reveal.js/plugin/markdown/markdown.js', condition: function () { return !!document.querySelector('[data-markdown]'); } },
          //{ src: 'bower_components/reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'bower_components/reveal.js/plugin/zoom-js/zoom.js', async: true, condition: function () { return !!document.body.classList; } },
          { src: 'bower_components/reveal.js/plugin/notes/notes.js', async: true, condition: function () { return !!document.body.classList; } }
        ]
      });
    </script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script src="js/script.js"></script>
    <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js?skin=desert&amp;callback=doov"></script>
  </body>
</html>
<!-- vim: set tabstop=2 softtabstop=2 shiftwidth=2 expandtab smarttab: -->
